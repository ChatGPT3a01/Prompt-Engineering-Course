<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Part9 é€²éšè©•èªåŠŸèƒ½ GAS ç¨‹å¼ç”Ÿæˆå™¨</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft JhengHei', 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #0d47a1 0%, #1565c0 50%, #1976d2 100%);
            min-height: 100vh;
            color: #333;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background-image:
                radial-gradient(2px 2px at 20px 30px, white, transparent),
                radial-gradient(2px 2px at 40px 70px, rgba(255,255,255,0.8), transparent),
                radial-gradient(1px 1px at 90px 40px, white, transparent),
                radial-gradient(2px 2px at 160px 120px, rgba(255,255,255,0.9), transparent);
            background-size: 550px 250px;
            animation: twinkle 8s ease-in-out infinite;
            pointer-events: none;
            z-index: 0;
        }

        @keyframes twinkle {
            0%, 100% { opacity: 0.8; }
            50% { opacity: 0.4; }
        }

        .nav-bar {
            position: fixed;
            top: 0; left: 0; right: 0;
            height: 60px;
            background: rgba(13, 71, 161, 0.95);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.15);
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 30px;
            z-index: 10000;
        }

        .nav-title {
            font-size: 20px;
            font-weight: 700;
            background: linear-gradient(90deg, #64b5f6, #90caf9);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .nav-buttons { display: flex; gap: 12px; flex-wrap: wrap; }

        .nav-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 8px 18px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            text-decoration: none;
            transition: all 0.3s ease;
        }

        .nav-btn:hover {
            background: rgba(100, 181, 246, 0.3);
            border-color: #64b5f6;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 100px 20px 40px;
            position: relative;
            z-index: 1;
        }

        .main-card {
            background: rgba(255, 255, 255, 0.97);
            border-radius: 24px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            padding: 40px;
            margin-bottom: 30px;
        }

        h1 {
            font-size: 32px;
            margin-bottom: 10px;
            text-align: center;
            background: linear-gradient(135deg, #0d47a1, #1976d2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .subtitle {
            text-align: center;
            color: #666;
            font-size: 16px;
            margin-bottom: 30px;
        }

        h2 {
            color: #0d47a1;
            font-size: 20px;
            margin: 30px 0 20px;
            border-bottom: 3px solid;
            border-image: linear-gradient(90deg, #0d47a1, #1976d2) 1;
            padding-bottom: 10px;
        }

        h2:first-of-type {
            margin-top: 0;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        label {
            display: block;
            font-weight: 600;
            color: #0d47a1;
            margin-bottom: 8px;
            font-size: 14px;
        }

        label .required {
            color: #c62828;
        }

        label .hint {
            font-weight: normal;
            color: #666;
            font-size: 12px;
            display: block;
            margin-top: 2px;
        }

        input[type="text"],
        input[type="password"],
        select,
        textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 14px;
            font-family: inherit;
            transition: all 0.3s;
        }

        input:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: #0d47a1;
            box-shadow: 0 0 10px rgba(13, 71, 161, 0.2);
        }

        /* åŠŸèƒ½é¸æ“‡å¡ç‰‡ */
        .feature-cards {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 25px;
        }

        .feature-card {
            border: 2px solid #e0e0e0;
            border-radius: 15px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            background: white;
        }

        .feature-card:hover {
            border-color: #1976d2;
            transform: translateY(-2px);
        }

        .feature-card.active {
            border-color: #0d47a1;
            background: linear-gradient(135deg, #e3f2fd, #bbdefb);
        }

        .feature-card .icon {
            font-size: 36px;
            margin-bottom: 10px;
        }

        .feature-card .title {
            font-weight: 700;
            color: #0d47a1;
            font-size: 16px;
            margin-bottom: 5px;
        }

        .feature-card .desc {
            font-size: 12px;
            color: #666;
        }

        .feature-card .badge {
            display: inline-block;
            background: #4caf50;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 10px;
            margin-top: 8px;
        }

        .feature-card .badge.optional {
            background: #ff9800;
        }

        /* æ¢ä»¶é¡¯ç¤ºå€å¡Š */
        .conditional-section {
            display: none;
            background: #f5f5f5;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .conditional-section.show {
            display: block;
        }

        .conditional-section h3 {
            color: #1565c0;
            font-size: 16px;
            margin-bottom: 15px;
        }

        .btn-group {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 30px;
        }

        .btn {
            padding: 15px 40px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            border: none;
        }

        .btn-primary {
            background: linear-gradient(135deg, #0d47a1, #1976d2);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(13, 71, 161, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #4caf50, #2e7d32);
            color: white;
        }

        .btn-secondary:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(76, 175, 80, 0.4);
        }

        .code-output {
            background: linear-gradient(135deg, #0d47a1, #1565c0);
            border-radius: 15px;
            padding: 25px;
            margin-top: 20px;
            position: relative;
            display: none;
        }

        .code-output.show {
            display: block;
        }

        .code-output pre {
            color: #bbdefb;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 12px;
            line-height: 1.5;
            overflow-x: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
            max-height: 500px;
            overflow-y: auto;
        }

        .code-actions {
            position: absolute;
            top: 15px;
            right: 15px;
            display: flex;
            gap: 10px;
        }

        .code-btn {
            background: rgba(255, 255, 255, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 8px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.3s;
        }

        .code-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .code-btn.copied {
            background: #4caf50;
            border-color: #4caf50;
        }

        .info-box {
            background: linear-gradient(135deg, #e3f2fd, #bbdefb);
            border-left: 4px solid #1976d2;
            padding: 15px 20px;
            border-radius: 0 10px 10px 0;
            margin: 15px 0;
        }

        .info-box h4 {
            color: #0d47a1;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .info-box p, .info-box li {
            font-size: 13px;
            color: #444;
        }

        .warning-box {
            background: linear-gradient(135deg, #fff3e0, #ffe0b2);
            border-left: 4px solid #ff9800;
            padding: 15px 20px;
            border-radius: 0 10px 10px 0;
            margin: 15px 0;
        }

        .warning-box h4 {
            color: #e65100;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .deploy-guide {
            background: linear-gradient(135deg, #e8f5e9, #c8e6c9);
            border-radius: 15px;
            padding: 25px;
            margin-top: 30px;
            display: none;
        }

        .deploy-guide.show {
            display: block;
        }

        .deploy-guide h3 {
            color: #2e7d32;
            margin-bottom: 15px;
        }

        .deploy-steps {
            display: grid;
            gap: 12px;
        }

        .deploy-step {
            display: flex;
            gap: 15px;
            align-items: flex-start;
        }

        .step-num {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: linear-gradient(135deg, #2e7d32, #4caf50);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 14px;
            flex-shrink: 0;
        }

        .step-content {
            flex: 1;
        }

        .step-content strong {
            color: #1b5e20;
        }

        .step-content p {
            margin: 0;
            font-size: 14px;
            color: #333;
        }

        .footer-info {
            text-align: center;
            color: white;
            margin-top: 30px;
            padding: 20px;
            opacity: 0.8;
        }

        .copy-btn {
            background: linear-gradient(135deg, #1976d2, #0d47a1);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .copy-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(13, 71, 161, 0.3);
        }

        @media (max-width: 768px) {
            .container { padding: 80px 15px 30px; }
            .main-card { padding: 25px; }
            h1 { font-size: 24px; }
            .form-row { grid-template-columns: 1fr; }
            .feature-cards { grid-template-columns: 1fr; }
            .btn { padding: 12px 25px; font-size: 14px; }
        }
    </style>
</head>
<body>
    <nav class="nav-bar">
        <span class="nav-title">Part9 é€²éšè©•èª GAS ç”Ÿæˆå™¨</span>
        <div class="nav-buttons">
            <a href="index.html" class="nav-btn">é¦–é </a>
            <a href="index2.html" class="nav-btn">å‰µè©•é‡é¦–é </a>
            <a href="Part9-1_å››å­—è©•èªç”Ÿæˆ.html" class="nav-btn">è¿”å›æ•™å­¸</a>
            <a href="https://www.youtube.com/@Liang-yt02" target="_blank" class="nav-btn">YT</a>
        </div>
    </nav>

    <div class="container">
        <div class="main-card">
            <h1>Part9 é€²éšè©•èªåŠŸèƒ½</h1>
            <p class="subtitle">GAS ç¨‹å¼ç¢¼ç”Ÿæˆå™¨ - å››å­—è©•èª + æ–‡å­—æ•˜è¿° + èªéŸ³åˆæˆ</p>

            <div class="info-box">
                <h4>èªªæ˜</h4>
                <p>æ­¤ç”Ÿæˆå™¨ç‚º Part8 LINE Bot çš„åŠŸèƒ½æ“´å……ï¼Œè«‹ç¢ºä¿å·²å®Œæˆ Part8 çš„åŸºç¤è¨­å®šã€‚é¸æ“‡è¦å•Ÿç”¨çš„åŠŸèƒ½å¾Œï¼Œå°‡ç”Ÿæˆæ•´åˆç¨‹å¼ç¢¼ã€‚</p>
            </div>

            <!-- åŠŸèƒ½é¸æ“‡ -->
            <h2>é¸æ“‡è¦å•Ÿç”¨çš„åŠŸèƒ½</h2>
            <div class="feature-cards">
                <div class="feature-card active" data-feature="fourChar" onclick="toggleFeature('fourChar')">
                    <div class="icon">âœ¨</div>
                    <div class="title">å››å­—è©•èª</div>
                    <div class="desc">ç”Ÿæˆå¦‚ã€Œæ¢ç´¢æœªçŸ¥ãƒ»å‹‡æ–¼å˜—è©¦ã€çš„å››å­—è©•èª</div>
                    <div class="badge">æ¨è–¦</div>
                </div>
                <div class="feature-card active" data-feature="descriptive" onclick="toggleFeature('descriptive')">
                    <div class="icon">ğŸ“</div>
                    <div class="title">æ–‡å­—æ•˜è¿°è©•èª</div>
                    <div class="desc">ç”Ÿæˆ 50-100 å­—çš„è©³ç´°æ–‡å­—å›é¥‹</div>
                    <div class="badge">æ¨è–¦</div>
                </div>
                <div class="feature-card" data-feature="tts" onclick="toggleFeature('tts')">
                    <div class="icon">ğŸ”Š</div>
                    <div class="title">èªéŸ³åˆæˆ (TTS)</div>
                    <div class="desc">å°‡è©•èªè½‰æ›ç‚ºèªéŸ³æª”æ¡ˆ</div>
                    <div class="badge optional">éœ€ Google Cloud</div>
                </div>
            </div>

            <!-- åŸºæœ¬è¨­å®š -->
            <h2>åŸºæœ¬è¨­å®šï¼ˆèˆ‡ Part8 ç›¸åŒï¼‰</h2>
            <div class="form-row">
                <div class="form-group">
                    <label>LINE Channel Access Token <span class="required">*</span>
                        <span class="hint">å¾ LINE Developers Console å–å¾—</span>
                    </label>
                    <input type="password" id="lineToken" placeholder="è«‹è²¼ä¸Šä½ çš„ LINE Channel Access Token">
                </div>
                <div class="form-group">
                    <label>Google è©¦ç®—è¡¨ ID <span class="required">*</span>
                        <span class="hint">ç”¨æ–¼è¨˜éŒ„è©•èªæ­·å²</span>
                    </label>
                    <input type="text" id="spreadsheetId" placeholder="ä¾‹å¦‚ï¼š1w5OjdXzs8NmGL...">
                </div>
            </div>

            <!-- AI æœå‹™é¸æ“‡ -->
            <h2>AI æœå‹™è¨­å®š</h2>
            <div class="feature-cards" style="grid-template-columns: repeat(2, 1fr);">
                <div class="feature-card active" data-provider="gemini" onclick="selectProvider('gemini')">
                    <div class="icon">ğŸ”·</div>
                    <div class="title">Google Gemini</div>
                    <div class="desc">å…è²»é¡åº¦å¤šï¼Œé©åˆæ•™è‚²ä½¿ç”¨</div>
                    <div class="badge">æ¨è–¦</div>
                </div>
                <div class="feature-card" data-provider="openai" onclick="selectProvider('openai')">
                    <div class="icon">ğŸŸ¢</div>
                    <div class="title">OpenAI GPT</div>
                    <div class="desc">å“è³ªç©©å®šï¼Œéœ€ä»˜è²» API</div>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group" id="geminiKeyGroup">
                    <label>Gemini API Key <span class="required">*</span>
                        <span class="hint">å¾ Google AI Studio å–å¾—</span>
                    </label>
                    <input type="password" id="geminiApiKey" placeholder="è«‹è²¼ä¸Šä½ çš„ Gemini API Key">
                </div>
                <div class="form-group" id="openaiKeyGroup" style="display: none;">
                    <label>OpenAI API Key <span class="required">*</span>
                        <span class="hint">å¾ OpenAI Platform å–å¾—</span>
                    </label>
                    <input type="password" id="openaiApiKey" placeholder="è«‹è²¼ä¸Šä½ çš„ OpenAI API Key">
                </div>
                <div class="form-group">
                    <label>æ¨¡å‹ç‰ˆæœ¬</label>
                    <select id="modelSelect">
                        <optgroup label="Gemini æ¨¡å‹" id="geminiModels">
                            <option value="gemini-2.5-flash" selected>gemini-2.5-flashï¼ˆæ¨è–¦ï¼‰</option>
                            <option value="gemini-2.0-flash">gemini-2.0-flash</option>
                            <option value="gemini-3-flash-preview">gemini-3-flash-previewï¼ˆæœ€æ–°ï¼‰</option>
                            <option value="gemini-3-pro-preview">gemini-3-pro-previewï¼ˆæœ€å¼·ï¼‰</option>
                        </optgroup>
                        <optgroup label="OpenAI æ¨¡å‹" id="openaiModels" style="display: none;">
                            <option value="gpt-4o">gpt-4oï¼ˆæ¨è–¦ï¼‰</option>
                            <option value="gpt-4o-mini">gpt-4o-miniï¼ˆä¾¿å®œå¿«é€Ÿï¼‰</option>
                            <option value="gpt-4.1">gpt-4.1ï¼ˆé€²éšç‰ˆæœ¬ï¼‰</option>
                            <option value="gpt-5.1">gpt-5.1ï¼ˆæœ€æ–°æœ€å¼·ï¼‰</option>
                        </optgroup>
                    </select>
                </div>
            </div>

            <!-- TTS è¨­å®šï¼ˆæ¢ä»¶é¡¯ç¤ºï¼‰ -->
            <div class="conditional-section" id="ttsSection">
                <h3>ğŸ”Š èªéŸ³åˆæˆè¨­å®š</h3>

                <!-- TTS æ–¹æ¡ˆé¸æ“‡ -->
                <p style="margin-bottom: 15px;">è«‹é¸æ“‡èªéŸ³åˆæˆæ–¹æ¡ˆï¼š</p>
                <div class="feature-cards" style="grid-template-columns: repeat(2, 1fr); margin-bottom: 20px;">
                    <div class="feature-card active" data-tts="cloud" onclick="selectTTSMethod('cloud')">
                        <div class="icon">â˜ï¸</div>
                        <div class="title">Google Cloud TTS</div>
                        <div class="desc">ç”Ÿæˆ MP3 éŸ³æª”ï¼Œå¯ä¸‹è¼‰åˆ†äº«</div>
                        <div class="badge">éœ€è¨­å®š API</div>
                    </div>
                    <div class="feature-card" data-tts="web" onclick="selectTTSMethod('web')">
                        <div class="icon">ğŸŒ</div>
                        <div class="title">Web Speech API</div>
                        <div class="desc">ç¶²é å³æ™‚æ’­æ”¾ï¼Œå®Œå…¨å…è²»</div>
                        <div class="badge" style="background: #4caf50;">å…è²»å…è¨­å®š</div>
                    </div>
                </div>

                <!-- Google Cloud TTS è¨­å®š -->
                <div id="cloudTTSSection">
                    <div class="info-box" style="margin-bottom: 20px;">
                        <h4>å¦‚ä½•å–å¾— Google Cloud API Keyï¼Ÿ</h4>
                        <ol style="margin: 10px 0 0 20px; line-height: 1.8;">
                            <li>å‰å¾€ <a href="https://console.cloud.google.com/" target="_blank" style="color: #1976d2;">Google Cloud Console</a></li>
                            <li>å»ºç«‹æ–°å°ˆæ¡ˆï¼ˆæˆ–é¸æ“‡ç¾æœ‰å°ˆæ¡ˆï¼‰</li>
                            <li>é»æ“Šå·¦å´é¸å–®ã€ŒAPI å’Œæœå‹™ã€â†’ã€Œå·²å•Ÿç”¨çš„ API å’Œæœå‹™ã€</li>
                            <li>é»æ“Šã€Œ+ å•Ÿç”¨ API å’Œæœå‹™ã€ï¼Œæœå°‹ã€ŒCloud Text-to-Speech APIã€ä¸¦å•Ÿç”¨</li>
                            <li>å›åˆ°ã€ŒAPI å’Œæœå‹™ã€â†’ã€Œæ†‘è­‰ã€</li>
                            <li>é»æ“Šã€Œ+ å»ºç«‹æ†‘è­‰ã€â†’ã€ŒAPI é‡‘é‘°ã€</li>
                            <li>è¤‡è£½ç”¢ç”Ÿçš„ API é‡‘é‘°ï¼Œè²¼åˆ°ä¸‹æ–¹æ¬„ä½</li>
                        </ol>
                        <p style="margin-top: 10px; color: #e65100;"><strong>æ³¨æ„ï¼š</strong>æ¯æœˆæœ‰å…è²»é¡åº¦ï¼ˆç´„ 100 è¬å­—å…ƒï¼‰ï¼Œè¶…éæ‰éœ€ä»˜è²»ã€‚</p>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Google Cloud API Key <span class="required">*</span>
                                <span class="hint">å¾ Google Cloud Console æ†‘è­‰é é¢å–å¾—</span>
                            </label>
                            <input type="password" id="googleCloudKey" placeholder="è«‹è²¼ä¸Šä½ çš„ Google Cloud API Key">
                        </div>
                        <div class="form-group">
                            <label>Google Drive è³‡æ–™å¤¾ ID <span class="required">*</span>
                                <span class="hint">ç”¨æ–¼å­˜æ”¾ç”Ÿæˆçš„éŸ³æª”ï¼ˆå¾è³‡æ–™å¤¾ç¶²å€å–å¾—ï¼‰</span>
                            </label>
                            <input type="text" id="driveFolderId" placeholder="ä¾‹å¦‚ï¼š1k4Tbtf8iqjc...">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>èªéŸ³èªè¨€</label>
                            <select id="ttsLanguage">
                                <option value="zh-TW" selected>ç¹é«”ä¸­æ–‡ï¼ˆå°ç£ï¼‰</option>
                                <option value="zh-CN">ç°¡é«”ä¸­æ–‡</option>
                                <option value="en-US">è‹±æ–‡</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>èªéŸ³æ€§åˆ¥</label>
                            <select id="ttsGender">
                                <option value="FEMALE" selected>å¥³è²</option>
                                <option value="MALE">ç”·è²</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Web Speech API èªªæ˜ -->
                <div id="webTTSSection" style="display: none;">
                    <div class="info-box" style="background: linear-gradient(135deg, #e8f5e9, #c8e6c9); border-color: #4caf50;">
                        <h4 style="color: #2e7d32;">Web Speech API ä½¿ç”¨æ–¹å¼</h4>
                        <p style="margin: 10px 0;"><strong>å„ªé»ï¼š</strong>å®Œå…¨å…è²»ã€ä¸éœ€è¦ä»»ä½• API Keyã€ç€è¦½å™¨å…§å»ºåŠŸèƒ½</p>
                        <p style="margin: 10px 0;"><strong>é™åˆ¶ï¼š</strong>åªèƒ½åœ¨ç¶²é ä¸Šå³æ™‚æ’­æ”¾ï¼Œç„¡æ³•ç”ŸæˆéŸ³æª”ä¸‹è¼‰</p>
                        <p style="margin: 10px 0 15px;"><strong>é©åˆï¼š</strong>åœ¨è©•é‡ç¶²ç«™ä¸ŠåŠ å…¥ã€Œæ’­æ”¾è©•èªã€æŒ‰éˆ•</p>

                        <h4 style="color: #2e7d32; margin-top: 15px;">å¦‚ä½•ä½¿ç”¨ï¼Ÿ</h4>
                        <p>åœ¨ä½ çš„è©•é‡ç¶²ç«™ HTML ä¸­åŠ å…¥ä»¥ä¸‹ç¨‹å¼ç¢¼ï¼š</p>
                        <div style="background: #1e3a5f; color: #b3e5fc; padding: 15px; border-radius: 10px; margin: 10px 0; font-family: monospace; font-size: 13px; overflow-x: auto;">
                            <pre style="margin: 0; white-space: pre-wrap;">&lt;!-- æ’­æ”¾æŒ‰éˆ• --&gt;
&lt;button onclick="speakText('é€™è£¡æ”¾è©•èªæ–‡å­—')"&gt;ğŸ”Š æ’­æ”¾è©•èª&lt;/button&gt;

&lt;script&gt;
function speakText(text) {
  // åœæ­¢ä¹‹å‰çš„æ’­æ”¾
  window.speechSynthesis.cancel();

  // å»ºç«‹èªéŸ³ç‰©ä»¶
  const utterance = new SpeechSynthesisUtterance(text);
  utterance.lang = 'zh-TW';  // ç¹é«”ä¸­æ–‡
  utterance.rate = 1.0;      // èªé€Ÿ (0.1-10)
  utterance.pitch = 1.0;     // éŸ³èª¿ (0-2)

  // æ’­æ”¾
  window.speechSynthesis.speak(utterance);
}
&lt;/script&gt;</pre>
                        </div>
                        <button class="copy-btn" style="margin-top: 10px;" onclick="copyWebSpeechCode()">è¤‡è£½ç¨‹å¼ç¢¼</button>
                    </div>
                </div>
            </div>

            <!-- è©•èªé¢¨æ ¼è¨­å®š -->
            <h2>è©•èªé¢¨æ ¼è¨­å®š</h2>
            <div class="form-row">
                <div class="form-group">
                    <label>èªæ°£é¢¨æ ¼</label>
                    <select id="toneStyle">
                        <option value="warm" selected>æº«æš–ã€é¼“å‹µã€æ­£å‘</option>
                        <option value="professional">å°ˆæ¥­ã€å­¸è¡“ã€æ­£å¼</option>
                        <option value="friendly">å‹å–„ã€è‡ªç„¶ã€è¦ªåˆ‡</option>
                        <option value="mentor">å¸«é•·é—œæ„›ã€å¾ªå¾ªå–„èª˜</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>æ–‡å­—è©•èªå­—æ•¸</label>
                    <select id="feedbackLength">
                        <option value="50-80" selected>50-80 å­—ï¼ˆç°¡æ½”ï¼‰</option>
                        <option value="80-120">80-120 å­—ï¼ˆé©ä¸­ï¼‰</option>
                        <option value="120-150">120-150 å­—ï¼ˆè©³ç´°ï¼‰</option>
                    </select>
                </div>
            </div>
            <div class="form-group full-width">
                <label>å››å­—è©•èªé¢¨æ ¼
                    <span class="hint">æè¿°å¸Œæœ›ç”Ÿæˆçš„å››å­—è©•èªé¢¨æ ¼</span>
                </label>
                <textarea id="fourCharStyle" rows="2" placeholder="ä¾‹å¦‚ï¼šä½¿ç”¨æ­£é¢é¼“å‹µçš„å››å­—è©èªï¼Œæ¯çµ„å››å­—ä¹‹é–“ç”¨ã€Œãƒ»ã€åˆ†éš”">ä½¿ç”¨æ­£é¢é¼“å‹µçš„å››å­—è©èªï¼Œæ ¼å¼ç‚ºã€Œâ—‹â—‹â—‹â—‹ãƒ»â—‹â—‹â—‹â—‹ã€ï¼Œä¾‹å¦‚ã€Œæ¢ç´¢æœªçŸ¥ãƒ»å‹‡æ–¼å˜—è©¦ã€ã€‚è©èªæ‡‰å…·é«”åæ˜ å­¸ç”Ÿä½œå“çš„ç‰¹è‰²ã€‚</textarea>
            </div>

            <div class="btn-group">
                <button class="btn btn-primary" onclick="generateCode()">ç”Ÿæˆç¨‹å¼ç¢¼</button>
                <button class="btn btn-secondary" onclick="resetForm()">é‡è¨­è¡¨å–®</button>
            </div>

            <!-- ç¨‹å¼ç¢¼è¼¸å‡º -->
            <div class="code-output" id="codeOutput">
                <div class="code-actions">
                    <button class="code-btn" onclick="copyCode()">è¤‡è£½ç¨‹å¼ç¢¼</button>
                    <button class="code-btn" onclick="downloadCode()">ä¸‹è¼‰ .gs æª”æ¡ˆ</button>
                </div>
                <pre id="codeContent"></pre>
            </div>

            <!-- éƒ¨ç½²æŒ‡å— -->
            <div class="deploy-guide" id="deployGuide">
                <h3>æ•´åˆæ­¥é©ŸæŒ‡å—</h3>
                <div class="deploy-steps">
                    <div class="deploy-step">
                        <span class="step-num">1</span>
                        <div class="step-content">
                            <p><strong>è¤‡è£½ç¨‹å¼ç¢¼</strong> - é»æ“Šä¸Šæ–¹ã€Œè¤‡è£½ç¨‹å¼ç¢¼ã€æŒ‰éˆ•</p>
                        </div>
                    </div>
                    <div class="deploy-step">
                        <span class="step-num">2</span>
                        <div class="step-content">
                            <p><strong>é–‹å•Ÿ GAS å°ˆæ¡ˆ</strong> - å‰å¾€ä½ åœ¨ Part8 å»ºç«‹çš„ Google Apps Script å°ˆæ¡ˆ</p>
                        </div>
                    </div>
                    <div class="deploy-step">
                        <span class="step-num">3</span>
                        <div class="step-content">
                            <p><strong>æ–°å¢æª”æ¡ˆ</strong> - é»æ“Šã€Œ+ã€æ–°å¢ä¸€å€‹ .gs æª”æ¡ˆï¼Œå‘½åç‚ºã€ŒPart9_Functionsã€</p>
                        </div>
                    </div>
                    <div class="deploy-step">
                        <span class="step-num">4</span>
                        <div class="step-content">
                            <p><strong>è²¼ä¸Šç¨‹å¼ç¢¼</strong> - å°‡è¤‡è£½çš„ç¨‹å¼ç¢¼è²¼å…¥æ–°æª”æ¡ˆä¸¦å„²å­˜</p>
                        </div>
                    </div>
                    <div class="deploy-step">
                        <span class="step-num">5</span>
                        <div class="step-content">
                            <p><strong>ä¿®æ”¹ä¸»ç¨‹å¼</strong> - åœ¨ä¸»ç¨‹å¼çš„ handleEvent ä¸­å‘¼å« Part9 å‡½æ•¸</p>
                        </div>
                    </div>
                    <div class="deploy-step">
                        <span class="step-num">6</span>
                        <div class="step-content">
                            <p><strong>é‡æ–°éƒ¨ç½²</strong> - é»æ“Šã€Œéƒ¨ç½²ã€â†’ã€Œç®¡ç†éƒ¨ç½²ã€â†’ã€Œå»ºç«‹æ–°ç‰ˆæœ¬ã€</p>
                        </div>
                    </div>
                    <div class="deploy-step">
                        <span class="step-num">7</span>
                        <div class="step-content">
                            <p><strong>æ¸¬è©¦åŠŸèƒ½</strong> - åŸ·è¡Œ testPart9Functions() æ¸¬è©¦æ–°åŠŸèƒ½</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="footer-info">
            Â© 2026 é˜¿äº®è€å¸« | AI æ™ºæ…§æ•™å­¸å¯¦æˆ°å·¥ä½œåŠ
        </div>
    </div>

    <script>
        // åŠŸèƒ½ç‹€æ…‹
        const features = {
            fourChar: true,
            descriptive: true,
            tts: false
        };

        // AI æœå‹™é¸æ“‡
        let selectedProvider = 'gemini';

        // TTS æ–¹æ¡ˆé¸æ“‡
        let selectedTTSMethod = 'cloud';

        function selectTTSMethod(method) {
            selectedTTSMethod = method;

            // æ›´æ–°å¡ç‰‡æ¨£å¼
            document.querySelectorAll('.feature-card[data-tts]').forEach(card => {
                card.classList.toggle('active', card.dataset.tts === method);
            });

            // åˆ‡æ›è¨­å®šå€å¡Šé¡¯ç¤º
            const cloudSection = document.getElementById('cloudTTSSection');
            const webSection = document.getElementById('webTTSSection');

            if (method === 'cloud') {
                cloudSection.style.display = 'block';
                webSection.style.display = 'none';
            } else {
                cloudSection.style.display = 'none';
                webSection.style.display = 'block';
            }
        }

        function copyWebSpeechCode() {
            const code = `<!-- æ’­æ”¾æŒ‰éˆ• -->
<button onclick="speakText('é€™è£¡æ”¾è©•èªæ–‡å­—')">ğŸ”Š æ’­æ”¾è©•èª</button>

<script>
function speakText(text) {
  // åœæ­¢ä¹‹å‰çš„æ’­æ”¾
  window.speechSynthesis.cancel();

  // å»ºç«‹èªéŸ³ç‰©ä»¶
  const utterance = new SpeechSynthesisUtterance(text);
  utterance.lang = 'zh-TW';  // ç¹é«”ä¸­æ–‡
  utterance.rate = 1.0;      // èªé€Ÿ (0.1-10)
  utterance.pitch = 1.0;     // éŸ³èª¿ (0-2)

  // æ’­æ”¾
  window.speechSynthesis.speak(utterance);
}
<\/script>`;

            navigator.clipboard.writeText(code).then(() => {
                const btn = document.querySelector('#webTTSSection .copy-btn');
                btn.textContent = 'å·²è¤‡è£½ï¼';
                btn.style.background = '#4caf50';
                btn.style.color = 'white';
                setTimeout(() => {
                    btn.textContent = 'è¤‡è£½ç¨‹å¼ç¢¼';
                    btn.style.background = '';
                    btn.style.color = '';
                }, 2000);
            });
        }

        function selectProvider(provider) {
            selectedProvider = provider;

            // æ›´æ–°å¡ç‰‡æ¨£å¼
            document.querySelectorAll('.feature-card[data-provider]').forEach(card => {
                card.classList.toggle('active', card.dataset.provider === provider);
            });

            // åˆ‡æ› API Key è¼¸å…¥æ¡†
            const geminiKeyGroup = document.getElementById('geminiKeyGroup');
            const openaiKeyGroup = document.getElementById('openaiKeyGroup');
            const geminiModels = document.getElementById('geminiModels');
            const openaiModels = document.getElementById('openaiModels');
            const modelSelect = document.getElementById('modelSelect');

            if (provider === 'gemini') {
                geminiKeyGroup.style.display = 'block';
                openaiKeyGroup.style.display = 'none';
                geminiModels.style.display = 'block';
                openaiModels.style.display = 'none';
                modelSelect.value = 'gemini-2.5-flash';
            } else {
                geminiKeyGroup.style.display = 'none';
                openaiKeyGroup.style.display = 'block';
                geminiModels.style.display = 'none';
                openaiModels.style.display = 'block';
                modelSelect.value = 'gpt-4o';
            }
        }

        function toggleFeature(feature) {
            features[feature] = !features[feature];
            const card = document.querySelector(`.feature-card[data-feature="${feature}"]`);
            card.classList.toggle('active', features[feature]);

            // TTS æ¢ä»¶é¡¯ç¤º
            if (feature === 'tts') {
                document.getElementById('ttsSection').classList.toggle('show', features.tts);
            }
        }

        function resetForm() {
            document.querySelectorAll('input[type="text"], input[type="password"]').forEach(input => {
                input.value = '';
            });
            document.getElementById('codeOutput').classList.remove('show');
            document.getElementById('deployGuide').classList.remove('show');
        }

        function generateCode() {
            const config = {
                lineToken: document.getElementById('lineToken').value.trim() || 'ä½ çš„_LINE_TOKEN',
                spreadsheetId: document.getElementById('spreadsheetId').value.trim() || 'ä½ çš„_SPREADSHEET_ID',
                geminiApiKey: document.getElementById('geminiApiKey').value.trim() || 'ä½ çš„_GEMINI_API_KEY',
                openaiApiKey: document.getElementById('openaiApiKey').value.trim() || 'ä½ çš„_OPENAI_API_KEY',
                model: document.getElementById('modelSelect').value,
                googleCloudKey: document.getElementById('googleCloudKey').value.trim() || 'ä½ çš„_GOOGLE_CLOUD_KEY',
                driveFolderId: document.getElementById('driveFolderId').value.trim() || 'ä½ çš„_DRIVE_FOLDER_ID',
                ttsLanguage: document.getElementById('ttsLanguage').value,
                ttsGender: document.getElementById('ttsGender').value,
                toneStyle: document.getElementById('toneStyle').value,
                feedbackLength: document.getElementById('feedbackLength').value,
                fourCharStyle: document.getElementById('fourCharStyle').value.trim()
            };

            const toneMap = {
                'warm': 'æº«æš–ã€é¼“å‹µã€æ­£å‘',
                'professional': 'å°ˆæ¥­ã€å­¸è¡“ã€æ­£å¼',
                'friendly': 'å‹å–„ã€è‡ªç„¶ã€è¦ªåˆ‡',
                'mentor': 'å¸«é•·é—œæ„›ã€å¾ªå¾ªå–„èª˜'
            };

            let code;
            if (selectedProvider === 'gemini') {
                code = generatePart9Code(config, toneMap);
            } else {
                code = generatePart9OpenAICode(config, toneMap);
            }

            document.getElementById('codeContent').textContent = code;
            document.getElementById('codeOutput').classList.add('show');
            document.getElementById('deployGuide').classList.add('show');
            document.getElementById('codeOutput').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        function generatePart9Code(config, toneMap) {
            const enabledFeatures = [];
            if (features.fourChar) enabledFeatures.push('å››å­—è©•èª');
            if (features.descriptive) enabledFeatures.push('æ–‡å­—æ•˜è¿°è©•èª');
            if (features.tts) enabledFeatures.push('èªéŸ³åˆæˆ');

            let code = `// ============================================
// Part9 é€²éšè©•èªåŠŸèƒ½ - Google Apps Script
// å•Ÿç”¨åŠŸèƒ½ï¼š${enabledFeatures.join('ã€')}
// æ¨¡å‹ï¼š${config.model}
// ç”Ÿæˆæ™‚é–“ï¼š${new Date().toLocaleString('zh-TW')}
// ============================================

// ===== Part9 è¨­å®šå¸¸æ•¸ =====
const PART9_GEMINI_API_KEY = '${config.geminiApiKey}';
const PART9_MODEL = '${config.model}';
const PART9_SPREADSHEET_ID = '${config.spreadsheetId}';
const PART9_LINE_TOKEN = '${config.lineToken}';
`;

            if (features.tts) {
                code += `
// TTS è¨­å®š
const GOOGLE_CLOUD_TTS_KEY = '${config.googleCloudKey}';
const TTS_DRIVE_FOLDER_ID = '${config.driveFolderId}';
const TTS_LANGUAGE = '${config.ttsLanguage}';
const TTS_GENDER = '${config.ttsGender}';
`;
            }

            code += `
// è©•èªé¢¨æ ¼è¨­å®š
const FEEDBACK_CONFIG = {
  tone: '${toneMap[config.toneStyle]}',
  feedbackLength: '${config.feedbackLength}',
  fourCharStyle: \`${config.fourCharStyle}\`
};
`;

            // å®Œæ•´è©•èªç”Ÿæˆå‡½æ•¸
            code += `
// ============================================
// å®Œæ•´è©•èªç”Ÿæˆï¼ˆæ•´åˆæ‰€æœ‰åŠŸèƒ½ï¼‰
// ============================================
function generateCompleteFeedback(studentWork, userId) {
  const result = {
    fourChar: '',
    feedback: '',
    audioUrl: null,
    timestamp: new Date()
  };

  try {
    // å‘¼å« AI ç”Ÿæˆè©•èª
    const aiResponse = callGeminiForFeedback(studentWork);
    const parsed = parseAIResponse(aiResponse);

    result.fourChar = parsed.fourChar || 'æŒçºŒåŠªåŠ›ãƒ»æœªä¾†å¯æœŸ';
    result.feedback = parsed.feedback || 'æ„Ÿè¬ä½ ç”¨å¿ƒå®Œæˆé€™ä»½ä½œå“ï¼è€å¸«å·²æ”¶åˆ°ä¸¦æœƒä»”ç´°é–±è®€ã€‚';
`;

            if (features.tts) {
                code += `
    // ç”ŸæˆèªéŸ³
    if (result.feedback) {
      const speechText = result.fourChar + 'ã€‚' + result.feedback;
      result.audioUrl = generateSpeech(speechText, 'feedback_' + userId.substring(0, 8));
    }
`;
            }

            code += `
    // è¨˜éŒ„åˆ°è©¦ç®—è¡¨
    logFeedbackToSheet(userId, studentWork, result);

  } catch (error) {
    Logger.log('generateCompleteFeedback Error: ' + error.toString());
    result.fourChar = 'å‹¤å­¸å¥½å•ãƒ»ç¹¼çºŒåŠ æ²¹';
    result.feedback = 'æ„Ÿè¬ä½ çš„ç”¨å¿ƒï¼Œè€å¸«æœƒä»”ç´°é–±è®€ä½ çš„ä½œå“ã€‚';
  }

  return result;
}
`;

            // AI å‘¼å«å‡½æ•¸
            if (features.fourChar || features.descriptive) {
                code += `
// ============================================
// Gemini API è©•èªç”Ÿæˆ
// ============================================
function callGeminiForFeedback(studentWork) {
  const url = \`https://generativelanguage.googleapis.com/v1beta/models/\${PART9_MODEL}:generateContent?key=\${PART9_GEMINI_API_KEY}\`;

  const maxLength = 6000;
  const truncatedWork = studentWork.length > maxLength
    ? studentWork.substring(0, maxLength) + '...(å·²æˆªå–)'
    : studentWork;

  const prompt = \`ä½ æ˜¯ä¸€ä½æº«æš–å°ˆæ¥­çš„æ•™å¸«ï¼Œè«‹è©•ä¼°å­¸ç”Ÿä½œå“ä¸¦ç”Ÿæˆè©•èªã€‚

## å­¸ç”Ÿä½œå“
\${truncatedWork}

## è©•èªè¦æ±‚
- èªæ°£ï¼š\${FEEDBACK_CONFIG.tone}
- å­—æ•¸ï¼š\${FEEDBACK_CONFIG.feedbackLength} å­—
${features.fourChar ? `- å››å­—è©•èªé¢¨æ ¼ï¼š\${FEEDBACK_CONFIG.fourCharStyle}` : ''}

## å›å‚³æ ¼å¼ï¼ˆåš´æ ¼ JSONï¼‰
{
${features.fourChar ? '  "fourChar": "â—‹â—‹â—‹â—‹ãƒ»â—‹â—‹â—‹â—‹",' : ''}
  "feedback": "50-100å­—æ–‡å­—è©•èªï¼Œå…·é«”æŒ‡å‡ºå„ªé»ä¸¦çµ¦äºˆé¼“å‹µ"
}

è«‹åªè¼¸å‡º JSONï¼Œä¸è¦åŠ ä»»ä½•èªªæ˜ã€‚\`;

  const payload = {
    contents: [{ parts: [{ text: prompt }] }],
    generationConfig: {
      temperature: 0.7,
      maxOutputTokens: 512
    }
  };

  const options = {
    method: 'post',
    contentType: 'application/json',
    payload: JSON.stringify(payload),
    muteHttpExceptions: true
  };

  const response = UrlFetchApp.fetch(url, options);
  const result = JSON.parse(response.getContentText());

  if (result.candidates && result.candidates[0]) {
    return result.candidates[0].content.parts[0].text;
  }
  throw new Error('Gemini API å›å‚³ç•°å¸¸');
}

function parseAIResponse(aiResponse) {
  try {
    const jsonMatch = aiResponse.match(/\\{[\\s\\S]*\\}/);
    if (jsonMatch) {
      return JSON.parse(jsonMatch[0]);
    }
  } catch (e) {
    Logger.log('parseAIResponse Error: ' + e.toString());
  }
  return { fourChar: '', feedback: aiResponse };
}
`;
            }

            // TTS å‡½æ•¸
            if (features.tts) {
                code += `
// ============================================
// Google Cloud TTS èªéŸ³åˆæˆ
// ============================================
function generateSpeech(text, fileName) {
  try {
    const url = 'https://texttospeech.googleapis.com/v1/text:synthesize?key=' + GOOGLE_CLOUD_TTS_KEY;

    const voiceName = TTS_LANGUAGE === 'zh-TW' ? 'zh-TW-Standard-A' :
                      TTS_LANGUAGE === 'zh-CN' ? 'zh-CN-Standard-A' : 'en-US-Standard-A';

    const payload = {
      input: { text: text },
      voice: {
        languageCode: TTS_LANGUAGE,
        name: voiceName,
        ssmlGender: TTS_GENDER
      },
      audioConfig: {
        audioEncoding: 'MP3',
        speakingRate: 1.0,
        pitch: 0
      }
    };

    const options = {
      method: 'post',
      contentType: 'application/json',
      payload: JSON.stringify(payload),
      muteHttpExceptions: true
    };

    const response = UrlFetchApp.fetch(url, options);
    const result = JSON.parse(response.getContentText());

    if (!result.audioContent) {
      Logger.log('TTS å›å‚³ç„¡éŸ³è¨Šå…§å®¹');
      return null;
    }

    // å„²å­˜åˆ° Google Drive
    const audioBytes = Utilities.base64Decode(result.audioContent);
    const audioBlob = Utilities.newBlob(audioBytes, 'audio/mpeg', fileName + '.mp3');
    const folder = DriveApp.getFolderById(TTS_DRIVE_FOLDER_ID);
    const file = folder.createFile(audioBlob);
    file.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);

    return file.getUrl();
  } catch (error) {
    Logger.log('generateSpeech Error: ' + error.toString());
    return null;
  }
}
`;
            }

            // æ ¼å¼åŒ–è¨Šæ¯
            code += `
// ============================================
// æ ¼å¼åŒ– LINE è¨Šæ¯
// ============================================
function formatFeedbackMessage(result) {
  let message = '';
${features.fourChar ? `
  if (result.fourChar) {
    message += 'âœ¨ã€å››å­—è©•èªã€‘âœ¨\\n' + result.fourChar + '\\n\\n';
  }
` : ''}
${features.descriptive ? `
  if (result.feedback) {
    message += 'ğŸ“ã€è€å¸«å›é¥‹ã€‘\\n' + result.feedback + '\\n';
  }
` : ''}
${features.tts ? `
  if (result.audioUrl) {
    message += '\\nğŸ”Šã€èªéŸ³ç‰ˆæœ¬ã€‘\\n' + result.audioUrl;
  }
` : ''}
  return message || 'æ„Ÿè¬ä½ çš„æäº¤ï¼è€å¸«æœƒç›¡å¿«çµ¦ä½ å›é¥‹ã€‚';
}
`;

            // è¨˜éŒ„å‡½æ•¸
            code += `
// ============================================
// è¨˜éŒ„åˆ°è©¦ç®—è¡¨
// ============================================
function logFeedbackToSheet(userId, content, result) {
  try {
    const spreadsheet = SpreadsheetApp.openById(PART9_SPREADSHEET_ID);
    let sheet = spreadsheet.getSheetByName('Part9è©•èªè¨˜éŒ„');

    if (!sheet) {
      sheet = spreadsheet.insertSheet('Part9è©•èªè¨˜éŒ„');
      sheet.getRange(1, 1, 1, 6).setValues([[
        'æ™‚é–“', 'LINE ID', 'ä½œå“å…§å®¹', 'å››å­—è©•èª', 'æ–‡å­—å›é¥‹', 'èªéŸ³é€£çµ'
      ]]);
      sheet.getRange(1, 1, 1, 6).setFontWeight('bold');
    }

    const timestamp = Utilities.formatDate(new Date(), 'Asia/Taipei', 'yyyy/MM/dd HH:mm:ss');
    sheet.appendRow([
      timestamp,
      userId.substring(0, 10) + '***',
      content.substring(0, 500),
      result.fourChar || '',
      result.feedback || '',
      result.audioUrl || ''
    ]);
  } catch (error) {
    Logger.log('logFeedbackToSheet Error: ' + error.toString());
  }
}
`;

            // æ•´åˆç”¨çš„ handleMessage å‡½æ•¸
            code += `
// ============================================
// æ•´åˆåˆ°ä¸»ç¨‹å¼çš„è¨Šæ¯è™•ç†
// ============================================
// åœ¨ä¸»ç¨‹å¼çš„ handleEvent ä¸­ï¼Œå°‡æ–‡å­—è¨Šæ¯è™•ç†æ”¹ç‚ºï¼š
//
// if (event.message.type === 'text') {
//   const result = generateCompleteFeedback(event.message.text, userId);
//   const message = formatFeedbackMessage(result);
//   replyMessage(replyToken, message);
// }

// ============================================
// æ¸¬è©¦å‡½æ•¸
// ============================================
function testPart9Functions() {
  Logger.log('===== Part9 åŠŸèƒ½æ¸¬è©¦ =====');

  const testWork = 'é€™æ¬¡æˆ‘ç ”ç©¶äº†äººå·¥æ™ºæ…§åœ¨æ•™è‚²é ˜åŸŸçš„æ‡‰ç”¨ã€‚æˆ‘ç™¼ç¾ AI å¯ä»¥å¹«åŠ©è€å¸«è¨­è¨ˆå€‹äººåŒ–çš„å­¸ç¿’è·¯å¾‘ï¼Œä¹Ÿèƒ½è‡ªå‹•æ‰¹æ”¹ä½œæ¥­ã€‚é€™è®“æˆ‘å°ç§‘æŠ€åœ¨æ•™è‚²ä¸­çš„è§’è‰²æœ‰äº†æ–°çš„èªè­˜ã€‚';

  Logger.log('æ¸¬è©¦ä½œå“ï¼š' + testWork.substring(0, 50) + '...');

  try {
    const result = generateCompleteFeedback(testWork, 'TEST_USER_123');
    Logger.log('å››å­—è©•èªï¼š' + result.fourChar);
    Logger.log('æ–‡å­—å›é¥‹ï¼š' + result.feedback);
${features.tts ? "    Logger.log('èªéŸ³é€£çµï¼š' + (result.audioUrl || 'æœªç”Ÿæˆ'));" : ''}
    Logger.log('æ ¼å¼åŒ–è¨Šæ¯ï¼š\\n' + formatFeedbackMessage(result));
    Logger.log('âœ… æ¸¬è©¦æˆåŠŸï¼');
  } catch (error) {
    Logger.log('âŒ æ¸¬è©¦å¤±æ•—ï¼š' + error.toString());
  }
}

function testGeminiAPI() {
  Logger.log('æ¸¬è©¦ Gemini API é€£ç·š...');
  try {
    const response = callGeminiForFeedback('é€™æ˜¯ä¸€ä»½æ¸¬è©¦ä½œå“ï¼Œä¸»é¡Œæ˜¯ç’°å¢ƒä¿è­·ã€‚');
    Logger.log('âœ… Gemini API æ­£å¸¸');
    Logger.log('å›æ‡‰ï¼š' + response);
  } catch (error) {
    Logger.log('âŒ Gemini API å¤±æ•—ï¼š' + error.toString());
  }
}
`;

            if (features.tts) {
                code += `
function testTTS() {
  Logger.log('æ¸¬è©¦ TTS èªéŸ³åˆæˆ...');
  try {
    const url = generateSpeech('é€™æ˜¯èªéŸ³åˆæˆæ¸¬è©¦ã€‚æ¢ç´¢æœªçŸ¥ï¼Œå‹‡æ–¼å˜—è©¦ï¼', 'test_tts');
    if (url) {
      Logger.log('âœ… TTS æˆåŠŸ');
      Logger.log('éŸ³æª”é€£çµï¼š' + url);
    } else {
      Logger.log('âŒ TTS å¤±æ•—ï¼šæœªç”ŸæˆéŸ³æª”');
    }
  } catch (error) {
    Logger.log('âŒ TTS å¤±æ•—ï¼š' + error.toString());
  }
}
`;
            }

            // ç¶²é ç«¯ TTS æ›¿ä»£æ–¹æ¡ˆ
            if (features.tts) {
                code += `
// ============================================
// æ›¿ä»£æ–¹æ¡ˆï¼šç¶²é ç«¯ Web Speech API
// ============================================
// å¦‚æœä¸ä½¿ç”¨ Google Cloud TTSï¼Œå¯åœ¨ç¶²é å‰ç«¯ä½¿ç”¨ä»¥ä¸‹ JavaScriptï¼š
//
// function speakFeedback(text) {
//   const utterance = new SpeechSynthesisUtterance(text);
//   utterance.lang = 'zh-TW';
//   utterance.rate = 1.0;
//   utterance.pitch = 1.0;
//   window.speechSynthesis.speak(utterance);
// }
//
// ä½¿ç”¨æ–¹å¼ï¼š<button onclick="speakFeedback('è©•èªæ–‡å­—')">ğŸ”Š æ’­æ”¾</button>
`;
            }

            return code;
        }

        // OpenAI ç‰ˆæœ¬çš„ç¨‹å¼ç¢¼ç”Ÿæˆ
        function generatePart9OpenAICode(config, toneMap) {
            const enabledFeatures = [];
            if (features.fourChar) enabledFeatures.push('å››å­—è©•èª');
            if (features.descriptive) enabledFeatures.push('æ–‡å­—æ•˜è¿°è©•èª');
            if (features.tts) enabledFeatures.push('èªéŸ³åˆæˆ');

            let code = `// ============================================
// Part9 é€²éšè©•èªåŠŸèƒ½ - Google Apps Script
// AI æœå‹™ï¼šOpenAI GPT
// å•Ÿç”¨åŠŸèƒ½ï¼š${enabledFeatures.join('ã€')}
// æ¨¡å‹ï¼š${config.model}
// ç”Ÿæˆæ™‚é–“ï¼š${new Date().toLocaleString('zh-TW')}
// ============================================

// ===== Part9 è¨­å®šå¸¸æ•¸ =====
const PART9_OPENAI_API_KEY = '${config.openaiApiKey}';
const PART9_MODEL = '${config.model}';
const PART9_SPREADSHEET_ID = '${config.spreadsheetId}';
const PART9_LINE_TOKEN = '${config.lineToken}';
`;

            if (features.tts) {
                code += `
// TTS è¨­å®š
const GOOGLE_CLOUD_TTS_KEY = '${config.googleCloudKey}';
const TTS_DRIVE_FOLDER_ID = '${config.driveFolderId}';
const TTS_LANGUAGE = '${config.ttsLanguage}';
const TTS_GENDER = '${config.ttsGender}';
`;
            }

            code += `
// è©•èªé¢¨æ ¼è¨­å®š
const FEEDBACK_CONFIG = {
  tone: '${toneMap[config.toneStyle]}',
  feedbackLength: '${config.feedbackLength}',
  fourCharStyle: \`${config.fourCharStyle}\`
};

// ============================================
// å®Œæ•´è©•èªç”Ÿæˆï¼ˆæ•´åˆæ‰€æœ‰åŠŸèƒ½ï¼‰
// ============================================
function generateCompleteFeedback(studentWork, userId) {
  const result = {
    fourChar: '',
    feedback: '',
    audioUrl: null,
    timestamp: new Date()
  };

  try {
    const aiResponse = callOpenAIForFeedback(studentWork);
    const parsed = parseAIResponse(aiResponse);

    result.fourChar = parsed.fourChar || 'æŒçºŒåŠªåŠ›ãƒ»æœªä¾†å¯æœŸ';
    result.feedback = parsed.feedback || 'æ„Ÿè¬ä½ ç”¨å¿ƒå®Œæˆé€™ä»½ä½œå“ï¼è€å¸«å·²æ”¶åˆ°ä¸¦æœƒä»”ç´°é–±è®€ã€‚';
`;

            if (features.tts) {
                code += `
    if (result.feedback) {
      const speechText = result.fourChar + 'ã€‚' + result.feedback;
      result.audioUrl = generateSpeech(speechText, 'feedback_' + userId.substring(0, 8));
    }
`;
            }

            code += `
    logFeedbackToSheet(userId, studentWork, result);

  } catch (error) {
    Logger.log('generateCompleteFeedback Error: ' + error.toString());
    result.fourChar = 'å‹¤å­¸å¥½å•ãƒ»ç¹¼çºŒåŠ æ²¹';
    result.feedback = 'æ„Ÿè¬ä½ çš„ç”¨å¿ƒï¼Œè€å¸«æœƒä»”ç´°é–±è®€ä½ çš„ä½œå“ã€‚';
  }

  return result;
}

// ============================================
// OpenAI API è©•èªç”Ÿæˆ
// ============================================
function callOpenAIForFeedback(studentWork) {
  const url = 'https://api.openai.com/v1/chat/completions';

  const maxLength = 6000;
  const truncatedWork = studentWork.length > maxLength
    ? studentWork.substring(0, maxLength) + '...(å·²æˆªå–)'
    : studentWork;

  const systemPrompt = \`ä½ æ˜¯ä¸€ä½æº«æš–å°ˆæ¥­çš„æ•™å¸«ï¼Œè«‹è©•ä¼°å­¸ç”Ÿä½œå“ä¸¦ç”Ÿæˆè©•èªã€‚

è©•èªè¦æ±‚ï¼š
- èªæ°£ï¼š\${FEEDBACK_CONFIG.tone}
- å­—æ•¸ï¼š\${FEEDBACK_CONFIG.feedbackLength} å­—
${features.fourChar ? `- å››å­—è©•èªé¢¨æ ¼ï¼š\${FEEDBACK_CONFIG.fourCharStyle}` : ''}

å›å‚³æ ¼å¼ï¼ˆåš´æ ¼ JSONï¼‰ï¼š
{
${features.fourChar ? '  "fourChar": "â—‹â—‹â—‹â—‹ãƒ»â—‹â—‹â—‹â—‹",' : ''}
  "feedback": "50-100å­—æ–‡å­—è©•èªï¼Œå…·é«”æŒ‡å‡ºå„ªé»ä¸¦çµ¦äºˆé¼“å‹µ"
}

è«‹åªè¼¸å‡º JSONï¼Œä¸è¦åŠ ä»»ä½•èªªæ˜ã€‚\`;

  const userPrompt = 'è«‹è©•ä¼°ä»¥ä¸‹å­¸ç”Ÿä½œå“ï¼š\\n\\n' + truncatedWork;

  const payload = {
    model: PART9_MODEL,
    messages: [
      { role: 'system', content: systemPrompt },
      { role: 'user', content: userPrompt }
    ],
    max_tokens: 512,
    temperature: 0.7
  };

  const options = {
    method: 'post',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': 'Bearer ' + PART9_OPENAI_API_KEY
    },
    payload: JSON.stringify(payload),
    muteHttpExceptions: true
  };

  const response = UrlFetchApp.fetch(url, options);
  const result = JSON.parse(response.getContentText());

  if (result.choices && result.choices[0]) {
    return result.choices[0].message.content;
  }
  throw new Error('OpenAI API å›å‚³ç•°å¸¸');
}

function parseAIResponse(aiResponse) {
  try {
    const jsonMatch = aiResponse.match(/\\{[\\s\\S]*\\}/);
    if (jsonMatch) {
      return JSON.parse(jsonMatch[0]);
    }
  } catch (e) {
    Logger.log('parseAIResponse Error: ' + e.toString());
  }
  return { fourChar: '', feedback: aiResponse };
}
`;

            // TTS å‡½æ•¸ï¼ˆèˆ‡ Gemini ç‰ˆæœ¬ç›¸åŒï¼‰
            if (features.tts) {
                code += `
// ============================================
// Google Cloud TTS èªéŸ³åˆæˆ
// ============================================
function generateSpeech(text, fileName) {
  try {
    const url = 'https://texttospeech.googleapis.com/v1/text:synthesize?key=' + GOOGLE_CLOUD_TTS_KEY;

    const voiceName = TTS_LANGUAGE === 'zh-TW' ? 'zh-TW-Standard-A' :
                      TTS_LANGUAGE === 'zh-CN' ? 'zh-CN-Standard-A' : 'en-US-Standard-A';

    const payload = {
      input: { text: text },
      voice: {
        languageCode: TTS_LANGUAGE,
        name: voiceName,
        ssmlGender: TTS_GENDER
      },
      audioConfig: {
        audioEncoding: 'MP3',
        speakingRate: 1.0,
        pitch: 0
      }
    };

    const options = {
      method: 'post',
      contentType: 'application/json',
      payload: JSON.stringify(payload),
      muteHttpExceptions: true
    };

    const response = UrlFetchApp.fetch(url, options);
    const result = JSON.parse(response.getContentText());

    if (!result.audioContent) {
      Logger.log('TTS å›å‚³ç„¡éŸ³è¨Šå…§å®¹');
      return null;
    }

    const audioBytes = Utilities.base64Decode(result.audioContent);
    const audioBlob = Utilities.newBlob(audioBytes, 'audio/mpeg', fileName + '.mp3');
    const folder = DriveApp.getFolderById(TTS_DRIVE_FOLDER_ID);
    const file = folder.createFile(audioBlob);
    file.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);

    return file.getUrl();
  } catch (error) {
    Logger.log('generateSpeech Error: ' + error.toString());
    return null;
  }
}
`;
            }

            // æ ¼å¼åŒ–è¨Šæ¯ã€è¨˜éŒ„å‡½æ•¸ã€æ¸¬è©¦å‡½æ•¸ï¼ˆèˆ‡ Gemini ç‰ˆæœ¬ç›¸åŒï¼‰
            code += `
// ============================================
// æ ¼å¼åŒ– LINE è¨Šæ¯
// ============================================
function formatFeedbackMessage(result) {
  let message = '';
${features.fourChar ? `
  if (result.fourChar) {
    message += 'âœ¨ã€å››å­—è©•èªã€‘âœ¨\\n' + result.fourChar + '\\n\\n';
  }
` : ''}
${features.descriptive ? `
  if (result.feedback) {
    message += 'ğŸ“ã€è€å¸«å›é¥‹ã€‘\\n' + result.feedback + '\\n';
  }
` : ''}
${features.tts ? `
  if (result.audioUrl) {
    message += '\\nğŸ”Šã€èªéŸ³ç‰ˆæœ¬ã€‘\\n' + result.audioUrl;
  }
` : ''}
  return message || 'æ„Ÿè¬ä½ çš„æäº¤ï¼è€å¸«æœƒç›¡å¿«çµ¦ä½ å›é¥‹ã€‚';
}

// ============================================
// è¨˜éŒ„åˆ°è©¦ç®—è¡¨
// ============================================
function logFeedbackToSheet(userId, content, result) {
  try {
    const spreadsheet = SpreadsheetApp.openById(PART9_SPREADSHEET_ID);
    let sheet = spreadsheet.getSheetByName('Part9è©•èªè¨˜éŒ„');

    if (!sheet) {
      sheet = spreadsheet.insertSheet('Part9è©•èªè¨˜éŒ„');
      sheet.getRange(1, 1, 1, 6).setValues([[
        'æ™‚é–“', 'LINE ID', 'ä½œå“å…§å®¹', 'å››å­—è©•èª', 'æ–‡å­—å›é¥‹', 'èªéŸ³é€£çµ'
      ]]);
      sheet.getRange(1, 1, 1, 6).setFontWeight('bold');
    }

    const timestamp = Utilities.formatDate(new Date(), 'Asia/Taipei', 'yyyy/MM/dd HH:mm:ss');
    sheet.appendRow([
      timestamp,
      userId.substring(0, 10) + '***',
      content.substring(0, 500),
      result.fourChar || '',
      result.feedback || '',
      result.audioUrl || ''
    ]);
  } catch (error) {
    Logger.log('logFeedbackToSheet Error: ' + error.toString());
  }
}

// ============================================
// æ¸¬è©¦å‡½æ•¸
// ============================================
function testPart9Functions() {
  Logger.log('===== Part9 åŠŸèƒ½æ¸¬è©¦ï¼ˆOpenAIï¼‰=====');

  const testWork = 'é€™æ¬¡æˆ‘ç ”ç©¶äº†äººå·¥æ™ºæ…§åœ¨æ•™è‚²é ˜åŸŸçš„æ‡‰ç”¨ã€‚æˆ‘ç™¼ç¾ AI å¯ä»¥å¹«åŠ©è€å¸«è¨­è¨ˆå€‹äººåŒ–çš„å­¸ç¿’è·¯å¾‘ï¼Œä¹Ÿèƒ½è‡ªå‹•æ‰¹æ”¹ä½œæ¥­ã€‚';

  Logger.log('æ¸¬è©¦ä½œå“ï¼š' + testWork.substring(0, 50) + '...');

  try {
    const result = generateCompleteFeedback(testWork, 'TEST_USER_123');
    Logger.log('å››å­—è©•èªï¼š' + result.fourChar);
    Logger.log('æ–‡å­—å›é¥‹ï¼š' + result.feedback);
${features.tts ? "    Logger.log('èªéŸ³é€£çµï¼š' + (result.audioUrl || 'æœªç”Ÿæˆ'));" : ''}
    Logger.log('æ ¼å¼åŒ–è¨Šæ¯ï¼š\\n' + formatFeedbackMessage(result));
    Logger.log('âœ… æ¸¬è©¦æˆåŠŸï¼');
  } catch (error) {
    Logger.log('âŒ æ¸¬è©¦å¤±æ•—ï¼š' + error.toString());
  }
}

function testOpenAIAPI() {
  Logger.log('æ¸¬è©¦ OpenAI API é€£ç·š...');
  try {
    const response = callOpenAIForFeedback('é€™æ˜¯ä¸€ä»½æ¸¬è©¦ä½œå“ï¼Œä¸»é¡Œæ˜¯ç’°å¢ƒä¿è­·ã€‚');
    Logger.log('âœ… OpenAI API æ­£å¸¸');
    Logger.log('å›æ‡‰ï¼š' + response);
  } catch (error) {
    Logger.log('âŒ OpenAI API å¤±æ•—ï¼š' + error.toString());
  }
}
`;

            return code;
        }

        function copyCode() {
            const code = document.getElementById('codeContent').textContent;
            navigator.clipboard.writeText(code).then(() => {
                const btns = document.querySelectorAll('.code-btn');
                btns[0].textContent = 'å·²è¤‡è£½ï¼';
                btns[0].classList.add('copied');
                setTimeout(() => {
                    btns[0].textContent = 'è¤‡è£½ç¨‹å¼ç¢¼';
                    btns[0].classList.remove('copied');
                }, 2000);
            });
        }

        function downloadCode() {
            const code = document.getElementById('codeContent').textContent;
            const blob = new Blob([code], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'Part9_Functions.gs';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>
